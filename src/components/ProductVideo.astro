---
interface Props {
  srcWebm?: string;
  srcMp4?: string;
  poster?: string;
  alt?: string;
}

const { srcWebm, srcMp4, poster, alt = "Product demo video" } = Astro.props;
---

<div class="video-container" data-video-lazy>
  <video
    class="product-video"
    muted
    loop
    playsinline
    preload="none"
    poster={poster}
    aria-label={alt}
  >
    {srcWebm && <source data-src={srcWebm} type="video/webm" />}
    {srcMp4 && <source data-src={srcMp4} type="video/mp4" />}
    Your browser does not support the video tag.
  </video>
</div>

<script>
  // Lazy-load video: only fetch and play when scrolled into view
  const observer = new IntersectionObserver(
    (entries) => {
      for (const entry of entries) {
        const video = entry.target.querySelector("video");
        if (!video) continue;

        if (entry.isIntersecting) {
          // Set real src on sources and start loading
          const sources = video.querySelectorAll("source[data-src]");
          sources.forEach((source) => {
            const src = source.getAttribute("data-src");
            if (src) {
              source.setAttribute("src", src);
              source.removeAttribute("data-src");
            }
          });
          video.load();
          video.play().catch(() => {});
          observer.unobserve(entry.target);
        }
      }
    },
    { rootMargin: "200px" } // Start loading 200px before entering viewport
  );

  document.querySelectorAll("[data-video-lazy]").forEach((el) => {
    observer.observe(el);
  });
</script>

<style>
  .video-container {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9;
    border-radius: var(--radius-xl);
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow:
      0 8px 32px rgba(0, 0, 0, 0.12),
      0 2px 8px rgba(0, 0, 0, 0.08),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    background-color: var(--color-gray-900);
  }

  .product-video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: top center;
    display: block;
  }

  .video-container::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    border-radius: inherit;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
  }

  @media (max-width: 768px) {
    .video-container {
      border-radius: var(--radius-lg);
    }
  }
</style>
